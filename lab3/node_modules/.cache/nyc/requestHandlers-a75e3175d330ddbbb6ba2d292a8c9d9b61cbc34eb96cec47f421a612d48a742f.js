const {MongoClient, ObjectId} = require('mongodb');
let url = "mongodb://localhost:27017"


function saveMessage(message) {
    return new Promise(function(resolve, reject) {
        MongoClient.connect(url, function(err, db) {
            let dbo = db.db("tdp013")
            dbo.collection("messages").insertOne(message, function(err, result) {
                if(err) { reject(err) }
                db.close()
                resolve(result)
            });  
        })
    })
}


async function flagMessage(id) {  
    let return_val
    await MongoClient.connect(url).then(async function(db) {
        let dbo = db.db("tdp013")
        dbo.collection("messages").findOne({_id : id}, function(err, result) {
            if(err) { return err }
            let flag = result.flag
            await dbo.collection("messages").updateOne({_id : id}, {$set: {flag : !flag}}).then(function(err, result) {
                if(err) { return err }
                db.close()
                return_val = result
            })
        }) 
    }).catch(function(err) {
        return err
    }) 
    return return_val
} 

/*
async function flagMessage(id) {
    return new Promise(function(resolve, reject) {
        let flag = true
        MongoClient.connect(url, function(err, db) {
            let dbo = db.db("tdp013")
            dbo.collection("messages").updateOne({_id : id}, {$set: {flag : !flag}}, function(err, result) {
                if(err) { return reject(err) }
                db.close() 
                resolve(result)
            })
        })
    })
} */

function getMessage(id) {
    return new Promise(function(resolve, reject) {
        MongoClient.connect(url, function(err, db) {
            let dbo = db.db("tdp013")
            dbo.collection("messages").findOne({_id : id}, function(err, result) {
                if(err) { return reject(err) }
                db.close()
                resolve(result)
            })
        })
    })
}

function getAllMessages() {
    return new Promise(function(resolve, reject) {
        MongoClient.connect(url, function(err, db) {
            let dbo = db.db("tdp013");
            dbo.collection("messages").find({}).toArray( function(err, result) {
                if(err) { return reject(err) }
                db.close()
                resolve(result)
            })  
        })

    })

}

module.exports = {saveMessage, flagMessage, getMessage, getAllMessages}